/*jslint browser: true*/
/*global define, console, $*/

define(['angular', 'dform'], function (angular) {
  'use strict';  

  var moduleDirectives = angular.module('CaliopeWebFormDirectives', []);
  
    moduleDirectives.directive('cwForm', function () {
      var directiveDefinitionObject = {
        restrict : 'E',
        replace : true,
        templateUrl : 'caliopeweb-forms/caliopeweb-form-partial.html',
        scope: {
          id   : '=id',
          mode : '=mode'
        }
      };

      return directiveDefinitionObject;
    
  });


  /**
   * Define the directive for <cw-dform>. This print a html form using the 
   * Dform library based in JQuery.  This directive should be used as an 
   * attribute, example: <form cw-dform="jsonPlantilla"></form>.  
   * 
   * This directive expect one attribute, it is the variable of scope that 
   * contains the representation of form according to the format specific for
   * Dform Library. For more information please visit
   * https://github.com/daffl/jquery.dform
   *  
   */
  moduleDirectives.directive('cwDform', function ($compile) {
    
    /**
     * Define the function for link the directive to AngularJS Context.
     */
    var directiveDefinitionObject = {
        link: function (scope, element, attrs) {

          /*
           * Function that print the form with dForm  
           */
          function renderDForm(templateData) {
            //var plantilla = JSON.parse(templateData);
            var plantilla = templateData;
            try {            
              $(element).dform(plantilla);              
            } catch (exDform) {
              console.log('Error generating the dynamic form with dForm', exDform);
            }
            try {
              $compile(element.contents())(scope);
            } catch (exCom) {
              console.log('Error compiling form generated:', exCom);
            }
          }

          /* Watch the change for attribute indicate in attribute cw-dform 
           * an update the form generated by Dform
           */
          scope.$watch(attrs.cwDform, function (value) {
            if (value !== undefined) {
              //console.log("Json to render", value);
              renderDForm(value);
            }
          });
          
        }
      };
    
    return directiveDefinitionObject;
    
  });

  /**
   */
  moduleDirectives.directive('cwValidationMess', function ($compile) {

    /**
     * Define the function for link the directive to AngularJS Context.
     */
    var directiveDefinitionObject = {
      restrict : 'E',
      replace : true,
      scope: true,
      templateUrl : 'caliopeweb-forms/caliopeweb-valmess-partial.html',
      link: function (scope, element, attrs) {
        scope['validationType'] = attrs['validationType'];
        $compile(element.contents())(scope);
      }
    };

    return directiveDefinitionObject;
  });

  
});

