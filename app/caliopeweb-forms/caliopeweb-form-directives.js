define(['angular'], function(angular) {
  'use strict';  

  var moduleDirectives = angular.module('CaliopeWebFormDirectives', []);
  
  moduleDirectives.directive('cwForm', function(){
    var directiveDefinitionObject ={
      restrict : 'E',
      replace : true,
      templateUrl : 'caliopeweb-forms/caliopeweb-form-partial.html',
      scope: {
        id   : '=id',
        mode : '=mode'
      }   
    };
    
    return directiveDefinitionObject;
    
  });
  
  /**
   * Define the directive for <cw-dform>. This print a html form using the 
   * Dform library based in JQuery.  This directive should be used as an 
   * attribute, example: <form cw-dform="jsonPlantilla"></form>.  
   * 
   * This directive expect one attribute, it is the variable of scope that 
   * contains the representation of form according to the format specific for
   * Dform Library. For more information please visit
   * https://github.com/daffl/jquery.dform
   *  
   */
  moduleDirectives.directive('cwDform', function($compile) {
    
    /**
     * Define the function for link the directive to AngularJS Context.
     */
    var linkFunction = function(scope, element, attrs) {       
      /* Watch the change for attribute indicate in attribute cw-dform 
       * an update the form generated by Dform
       */
        scope.$watch(attrs.cwDform, function(value) {
          if( value != null ) {
            renderDForm(value);
          }
      });
      
      /*
       * Function that print the form with dForm  
       */
      function renderDForm(jsonPlantilla) {
        try {
          //var plantilla = JSON.parse(jsonPlantilla);
          var plantilla = jsonPlantilla;
          $(element).dform(plantilla); 
          $compile(element.contents())(scope);
        } catch (e) {
          console.log('Error generating the dynamic form with dForm:', e)
        }
      }      
    }
    
    return linkFunction;
    
  });
  
});

